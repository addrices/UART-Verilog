# 串口

**通用异步收发器**（Universal Asynchronous Receiver/Transmitter)，通常称作**UART，是一种串行、异步、全双工的通信协议**，在嵌入式领域应用的非常广泛。

　　UART作为异步串行通信协议的一种，工作原理是将传输数据的每个二进制位一位接一位地传输。在UART通信协议中信号线上的状态为高电平时代表‘1’，信号线上的状态为低电平时代表‘0’。比如使用UART通信协议进行一个字节数据的传输时就是在信号线上产生八个高低电平的组合。

- 串行通信是指利用一条传输线将数据一位位地顺序传送，也可以用两个信号线组成全双工通信，如rs232。特点是通信线路简单，利用简单的线缆就可实现通信，降低成本，适用于远距离通信，但传输速度慢的应用场合。
- 异步通信以一个字符为传输单位，通信中两个字符间的时间间隔多少是不固定的，然而在同一个字符中的两个相邻位间的时间间隔是固定的。通俗说是两个uart设备之间通信的时候不需要时钟线，这时候就需要在两个uart设备上指定相同的传输速率，以及空闲位、起始位、校验位、结束位，也就是遵循相同的协议。
- 数据传送速率用波特率来表示，即每秒钟传送的二进制位数。例如数据传送速率为120字符/秒，而每一个字符为10位（1个起始位，7个数据位，1个校验位，1个结束位），则其传送的波特率为10×120＝1200字符/秒＝1200波特。

## 协议

板子上的串口有UART_TXD_IN，UART_RXD_OUT，UART_CTS，UART_RTS四根线，其中UART_TXD_IN，UART_RXD_OUT分别负责数据的串行输入和输出，UART_CTS和UART_RTS表示发送和接收使能，RTS （Require ToSend，发送请求）为输出信号，用于指示本设备准备好可接收数据，低电平有效，低电平说明本设备可以接收数据。CTS （Clear ToSend，发送允许）为输入信号，用于判断是否可以向对方发送数据，低电平有效，低电平说明本设备可以向对方发送数据。

### **波特率**

串口异步通讯中由于没有时钟信号，所以通讯双方需要约定好波特率，即每个码元的长度，以便对信号进行解码。常见的波特率有4800、9600、115200等。表示一秒串行传输的bit数。

### **起始位、停止位**

数据包从起始位开始，到停止位结束。起始信号用逻辑0的数据位表示，停止信号由0.5、1、1.5或2个逻辑1的数据位表示，只要双方约定一致即可。

串口线的

### **有效数据**

起始位之后便是传输的主体数据内容了，也称为有效数据，其长度一般被约定为5、6、7或8位长。

### **数据校验**

由于在通讯过程中易受到外部干扰导致传输数据出现偏差，所以在有效数据之后加上校验位解决。校验方法有奇校验（odd）、偶校验（even）、0校验（space）、1校验（mark）及无校验（noparity）。奇校验要求有效数据和校验位中“1”的个数为奇数，比如一个8位长的有效数据为：01101001，此时共有4个“1”，为达到奇校验效果，校验位为“1”，最后传输的是8位有效数据加1位校验位，共9位。

偶校验刚好相反，要求有效数据和校验位的“1”数量为偶数，则此时为达到偶校验效果，校验位为“0”。而0校验则无论有效数据中是什么数据内容，校验位总是为“0”，1校验校验位总是为“1”。 

### 数据传输

一次数据接收即UART_TXD_IN以设定好的波特率串行输入数据包，由于串口空闲的时候信号为1，检测到第一个0的时候认为串口开始传输。之后8位是数据，再之后是校验位，再之后是1到2位1作为停止位。

## 工程说明

### 收模块

```
module serial_rx(clk,txd_in,rx_data,rx_valid,rx_error);
input clk;
input txd_in;
output [transbit-1:0] rx_data;
output rx_valid;
output reg rx_error;
```

在收模块中，clk为系统时钟，txd_in为串口的txd_in信号，rx_data为接收到的数据，rx_valid会有效一个周期，用于指示rx_data的有效性，当串口传输中出现错误rx_error会拉高。

### 发模块

```
module serial_tx(clk,data,tx_valid,tx_ready,tx_out);
input clk;
input [transbit-1:0] data;
input tx_valid;
output reg tx_out;
output tx_ready;
```

在发模块中，clk为系统时钟，data为串口需要传输的信号，tx_valid是外部需要发送的信号的有效位，tx_out为串口的tx_out信号，tx_ready不会立刻响应tx_valid，需要外部模块发送tx_valid后，发现tx_ready从1到0这个动作后，认为发模块已经接收了串口需要传输的信号。

### 顶层模块

顶层模块作为演示，我将收模块的信号输入到一个队列再接到发模块，所以可以达到串口输入，软件上便会打印输入字符的效果。